```{r}
library(tidyverse)
library(plotly)
library(treeio)
library(ggtree)
library(ggtreeExtra)
library(svglite)
```

Creates a BGC table for Myxococcota, might take a few minutes

```{bash}
Rscript ~/AS_hqMAGs/r_markdown/notebook/bgc_table.R \
  --antismash_dir  ~/p__Myxococcota_all/antismash/6.0.1/ \
  --bigscape_dir ~/p__Myxococcota_all/bigscape/p__Myxococcota_all_antismash_6.0.1/network_files/2022-02-01_09-33-46_glocal_p__Myxococcota_all_antismash_6.0.1/ \
  --output  ~/AS_hqMAGs/r_markdown/tables/p__Myxococcota_all_bgcs.csv
```
Downloads metadata table from GTDB, might take a few minutes

```{bash include=FALSE}
wget --output-document ~/AS_hqMAGs/r_markdown/data/bac120_metadata_r202.tar.gz \
https://data.gtdb.ecogenomic.org/releases/release202/202.0/bac120_metadata_r202.tar.gz
tar -xvzf ~/AS_hqMAGs/r_markdown/data/bac120_metadata_r202.tar.gz
```

Creates a genome table for Myxococcota

```{bash}
Rscript ~/AS_hqMAGs/r_markdown/notebook/genome_table.R \
  --bgcs_table ~/AS_hqMAGs/r_markdown/tables/p__Myxococcota_all_bgcs.csv \
  --gtdbtk_summary ~/AS_hqMAGs/r_markdown/data/gtdbtk.bac120.summary.tsv \
  --supplementary_file  ~/AS_hqMAGs/r_markdown/data/singleton_2021_table3.xlsx \
  --assembly_details ~/AS_hqMAGs/r_markdown/data/assembly_details.txt \
  --output ~/AS_hqMAGs/r_markdown/tables/p__Myxococcota_all_genomes.csv \
  --gtdb_metadata ~/AS_hqMAGs/r_markdown/data/bac120_metadata_r202.tsv 
```

Imports both tables and the tree

```{r}
genomes <- read_csv("~/AS_hqMAGs/r_markdown/tables/p__Myxococcota_all_genomes.csv", 
                    show_col_types = FALSE)  %>%
  filter(str_detect(gtdb_taxonomy, "p__Myxococcota")) %>%
  filter(mimag_quality != "LQ")

bgcs <- read_csv("~/AS_hqMAGs/r_markdown/tables/p__Myxococcota_all_bgcs.csv", 
                 show_col_types = FALSE) %>%
  filter(genome_id %in% genomes$genome_id)

gtdb_tree <- read.newick("~/AS_hqMAGs/r_markdown/data/gtdbtk.bac120.classify.tree")

taxon <- "p__Myxococcota"

taxon_node <- gtdb_tree$node.label[str_detect(gtdb_tree$node.label, taxon)]

phylum_tree <- tree_subset(gtdb_tree, node = taxon_node, levels_back = 0)

phylum_tree$node.label <- str_extract(phylum_tree$node.label, '.__.*$') %>%
  str_replace_all('\'', '')
```


Customize BiG-SCAPE classes and color palette

```{r}
bigscape_classes <- c("Terpene",
                      "RiPPs", 
                      "NRPS",
                      "PKS-NRP_Hybrids",
                      "PKSI",
                      "PKSother", 
                      "Saccharides",
                      "Others")                             

my_classes <- c("Terpene", 
                "RiPP", 
                "NRPS", 
                "NRPS-PKS", 
                "PKS", 
                "PKS", 
                "Other", 
                "Other")

my_colors <- c("#ff8800",
               "#20c200",
               "#ff0000",
               "#dd00ff",
               "#0d00ff",
               "#757575")
```

Boxplots

```{r}

boxplots_ds <- genomes %>%
 
  mutate(perc_contig_edge = bgcs_on_contig_edge/total_bgcs, 
         quality = case_when(
           ncbi_bioproject == "PRJNA629478" ~ "AS hqMAG", 
           assembly_level == "Complete/Chromosome" ~ assembly_level,  
           assembly_level == "Contig/Scaffold" ~ mimag_quality), 
         taxonomy = str_replace_all(gtdb_taxonomy, ";", "\n"))

boxplots <- ggplot(boxplots_ds, 
       aes(x = quality, 
           y = perc_contig_edge, 
           label = taxonomy)) +
  geom_boxplot() +
  geom_jitter(aes(color = source), 
              alpha = 0.5,
              height = 0.02) +
  scale_color_manual(values = c('red', 'black')) +
  theme_minimal() +
  theme(axis.text.x = element_text(hjust = 0.5))+
  ylab("% of BGCs on a contig edge") +
  xlab("")

ggsave(boxplots, 
       filename = "figures/boxplot_myxo.svg", 
       device = "svg", 
       height = 4, 
       width = 4.5, 
       units = "in")

ggplotly(boxplots)

```

What family should we focus on? Polyangiaceae is well represented by our MAGs and the references. 

```{r}

families_boxplots_ds <- genomes %>%
  group_by(family = str_sub(str_extract(gtdb_taxonomy, "f__.*?;"), end= -2)) %>%
  mutate(AS_hqMAG = ncbi_bioproject == "PRJNA629478") %>%
  filter(sum(AS_hqMAG) > 1) %>%
  mutate(taxonomy = str_replace_all(gtdb_taxonomy, ";", "\n"))

families_boxplots <- ggplot(families_boxplots_ds, 
       aes(x = family, y  = total_bgcs, label = taxonomy))   +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(fill = AS_hqMAG, 
                  color = source), 
              shape = 21) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = c(NA, "black"))

ggplotly(families_boxplots)

```

Overview of the phylum Myxococcota

```{r echo=FALSE, fig.height=15, fig.width=10}

phylum_tree_ds <- bgcs %>%
   mutate(class = factor(class, levels = bigscape_classes), 
         class = my_classes[as.numeric(class)], 
         class = factor(class, levels = unique(my_classes))) %>%
  group_by(genome_id, class) %>%
  tally()
  
plot_tree <- ggtree(phylum_tree)

relative_widths <- phylum_tree_ds %>% 
  group_by(class) %>% 
  summarise(n = max(n)) %>% 
  pull(n)

bgcs_tree <- plot_tree

for (i in 1:length(unique(my_classes))){
  
  nbreaks <- relative_widths[i]/2
  title  <- my_classes[i]
  
  bgcs_tree <- bgcs_tree +
    geom_fruit(data = phylum_tree_ds[phylum_tree_ds$class == my_classes[i],], 
               geom = "geom_bar", 
               mapping = aes(y = genome_id, 
                             x = n, 
                             group = label), 
               pwidth = 0.015 * relative_widths[i],
               stat = "identity", 
               orientation = "y",
               fill = my_colors[i], 
               axis.params = list(axis = "x",
                                  text.size = 3,
                                  vjust = 1,
                                  nbreak = nbreaks,
                                  line.size = NA),
               grid.params = list(vline = FALSE)) 
}

families_df <- as_tibble(phylum_tree) %>% 
  filter(str_detect(label, 'f__')) %>% 
  mutate(label = str_replace(label, "-", ";"))

families_df$leaves <- sapply(
  lapply(
  families_df$label, 
  grepl, 
  x = genomes$gtdb_taxonomy), 
  sum)

families_df <- filter(families_df, leaves > 5)

annotated_tree <- bgcs_tree  +
  geom_highlight(data = families_df,
                 mapping = aes(node = node), 
                 fill = NA,
                 color = "lightgray",
                 extend = 10) +
  theme(legend.position = "none", 
        strip.background = element_rect(color = "gray95"), 
        strip.text = element_text(size = 10)) 

collapsed_tree <- annotated_tree

for (i in 1:nrow(families_df)) {
  collapsed_tree <- collapse(
    collapsed_tree, 
    clade_name = families_df$label[i], 
    node = families_df$node[i], 
    mode = "mixed", 
    color = "black", 
    fill = "gray95") }

clades_tree <- collapsed_tree  +
  geom_cladelab(data = families_df ,
                mapping = aes(node = node, label = label),
                barsize = NA, 
                geom = 'text', 
                colour = 'grey',
                bg.colour = 'white', 
                align = TRUE,
                offset = 0.3,
                hjust = 1,
                bg.r = 0.1,
                size =1.5)

clades_tree

```

Absence / Presence matrix for f__Polyangiaceae

```{r fig.height=7, fig.width=9}
family_ds <- 
  filter(genomes, str_detect(gtdb_taxonomy, 'f__Polyangiaceae')) %>%
  filter(source == "refseq" |  ncbi_bioproject == "PRJNA629478") %>%
  mutate(species = str_extract(gtdb_taxonomy, "s__.*"), 
         species = str_sub(species, start = 4), 
         tip_label = paste(genome_id, species))

family <- "f__Polyangiaceae"

family_tree <- tree_subset(
  phylum_tree,
  node = families_df$node[families_df$label == family], 
  levels_back = 0)

tips_to_drop <- family_tree$tip.label[
  family_tree$tip.label %in% family_ds$genome_id == FALSE]

family_tree <- drop.tip(family_tree, tips_to_drop)

data_tree <- left_join(family_tree,
                         family_ds[,c("genome_id", "tip_label")],
                         by = c("label" = "genome_id"))

#family_tree <- treeio::full_join(family_tree,
#                         family_ds[,c("genome_id","tip_label")]
#                         , by = c("label"= "genome_id"))
#
matrix_ds <- bgcs %>%
  filter(genome_id %in% family_tree$tip.label) %>%
  mutate(GCF = str_split(GCF, ";")) %>%
  unnest(GCF) %>%
    mutate(class = factor(class, levels = bigscape_classes), 
         class = my_classes[as.numeric(class)]) %>%
  mutate(string = paste0(GCF, ": ", product))  %>%
  group_by(string) %>%
  filter(n() > 1) 


matrix_ds <- expand_grid(
  unique(matrix_ds$string), 
  unique(matrix_ds$genome_id)) %>%
  setNames(c("string", "genome_id")) %>%
  left_join(matrix_ds, by = c("string", "genome_id")) %>%
  mutate(class = factor(class, levels = unique(my_classes))) %>%
  arrange(class, product) %>%
  mutate(string = factor(string, levels = unique(string))) 
 
tree_matrix <-  ggtree(data_tree) + 

    geom_fruit(
  geom = "geom_point", 
  data = matrix_ds[is.na(matrix_ds$class) == FALSE,], 
  mapping = aes(
    fill = class,
    x = string, 
    y = genome_id), 
  size = 1.5, 
  offset = 0.25,
  shape = 21, 
  pwidth = 4,
  axis.params = list(axis = "x", 
                     text.size = 2.5, 
                     text.angle = 90, 
                     hjust =1),
  grid.params = list(vline = TRUE, 
                     size = 1, 
                     color = "gray95"),
  color = "gray95") +
  scale_fill_manual(values = my_colors, 
                    na.value = "gray95")  +
  theme(legend.position = "top", 
        legend.direction = "horizontal",
        legend.box.spacing = unit(x=c(0,0,0,0),units="mm")) +
  scale_y_continuous(expand = c(0, 10, 0, 0)) +
  scale_shape_manual(values = c(NA, 15)) +
 guides(shape = FALSE,
        fill = guide_legend(nrow = 1,
                            label.theme = element_text(size = 7), 
                            title = "")) +
  geom_fruit(
    geom = "geom_bar", 
    data = family_ds, 
    mapping = aes(
      x = total_bgcs, 
      y = genome_id), 
    orientation = "y", 
    stat = "identity", 
    title = "Total BGCs",
    pwidth = 1,
    axis.params = list(axis = "x"), 
    grid.params = list(vline = TRUE)) +
  
  geom_tiplab(aes(label = tip_label))
  
```





